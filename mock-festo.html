<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festo CP Lab | Live Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #f1f5f9; /* Slate 100 */
        }

        /* Progress Bar Animation */
        @keyframes growWidth {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .animate-growWidth {
            animation-name: growWidth;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        /* Spin Animation for AGV */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }

        /* Station Card Transitions */
        .station-card {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen p-6">

    <!-- HEADER -->
    <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-700 pb-6">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
                <i data-lucide="settings" class="w-8 h-8 text-sky-500"></i>
                Festo CP Lab <span class="text-slate-500 font-light">| Live Monitor</span>
            </h1>
            <p class="text-slate-400 mt-2 max-w-2xl">
                Real-time visual dashboard for visitor engagement. Displaying PLC status, throughput bottlenecks, and AGV logistics.
            </p>
        </div>
        
        <div class="mt-4 md:mt-0 flex gap-4">
            <!-- OEE Widget -->
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 text-center min-w-[120px]">
                <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">OEE Efficiency</div>
                <div id="oee-display" class="text-2xl font-bold text-emerald-400">72%</div>
            </div>
            <!-- Alerts Widget -->
            <div id="alert-box" class="p-4 rounded-lg border text-center min-w-[120px] bg-slate-800 border-slate-700">
                <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Active Alerts</div>
                <div id="alert-count" class="text-2xl font-bold text-slate-200">0</div>
            </div>
        </div>
    </header>

    <!-- MAIN GRID -->
    <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- ISLAND 1 -->
        <section class="lg:col-span-5 flex flex-col gap-4">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-xl font-semibold text-sky-300">Island 1: Assembly</h2>
                <span class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400">PLC: 192.168.0.10</span>
            </div>
            <div id="island-1-container" class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 space-y-3">
                <!-- Stations injected by JS -->
            </div>
        </section>

        <!-- AGV / LOGISTICS CENTER -->
        <section class="lg:col-span-2 flex flex-col justify-center items-center py-6 relative">
            <!-- Connecting Line -->
            <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-700 -z-10 transform -translate-y-1/2 hidden lg:block"></div>
            
            <div class="bg-slate-900 border-2 border-slate-600 p-6 rounded-full shadow-2xl z-10 w-48 h-48 flex flex-col items-center justify-center relative overflow-hidden group">
                <div class="absolute inset-0 bg-sky-500/5 animate-pulse"></div>
                <i id="agv-icon" data-lucide="refresh-cw" class="w-10 h-10 text-sky-400 mb-2"></i>
                <div class="text-white font-bold text-lg">Robotino</div>
                <div id="agv-status" class="text-sky-300 text-xs text-center px-2 mt-1">IDLE</div>
                
                <!-- Battery Bar -->
                <div class="absolute bottom-4 flex items-center gap-1">
                    <i data-lucide="zap" class="w-3 h-3 text-yellow-400 fill-yellow-400"></i>
                    <div class="w-12 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                        <div id="agv-battery" class="h-full bg-yellow-400" style="width: 85%"></div>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <div class="text-slate-500 text-sm">Transferring Pallets</div>
                <div class="text-slate-600 text-xs mt-1">Simulated Latency: 24ms</div>
            </div>
        </section>

        <!-- ISLAND 2 -->
        <section class="lg:col-span-5 flex flex-col gap-4">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-xl font-semibold text-sky-300">Island 2: Processing</h2>
                <span class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400">PLC: 192.168.0.20</span>
            </div>
            <div id="island-2-container" class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 space-y-3">
                <!-- Stations injected by JS -->
            </div>
        </section>

    </main>

    <!-- FOOTER LEGEND -->
    <footer class="mt-12 pt-6 border-t border-slate-800 flex flex-wrap gap-6 text-sm text-slate-400">
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-emerald-500"></span> Running
        </div>
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-blue-500"></span> Idle / Starved
        </div>
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-amber-500"></span> Blocked / Queueing
        </div>
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-red-500"></span> Error
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA & STATE ---
        const INITIAL_STATIONS = [
            { id: 'mag_front', name: 'Magazine (Front)', island: 1, status: 'RUNNING', cycleTime: 5, waitTime: 0.5 },
            { id: 'branch_1', name: 'Branch Station 1', island: 1, status: 'RUNNING', cycleTime: 5, waitTime: 1.2 },
            { id: 'branch_2', name: 'Branch Station 2', island: 1, status: 'IDLE', cycleTime: 5, waitTime: 0.8 },
            { id: 'measuring', name: 'Measuring Module', island: 1, status: 'RUNNING', cycleTime: 10, waitTime: 2.5 },
            { id: 'mag_back', name: 'Magazine (Back)', island: 2, status: 'RUNNING', cycleTime: 5, waitTime: 0.5 },
            { id: 'muscle', name: 'Muscle Press', island: 2, status: 'BLOCKED', cycleTime: 10, waitTime: 15.0 }, 
            { id: 'heating', name: 'Heating Tunnel', island: 2, status: 'RUNNING', cycleTime: 20, waitTime: 0.0 }, 
            { id: 'output', name: 'Output Module', island: 2, status: 'IDLE', cycleTime: 5, waitTime: 18.0 },
        ];

        const AGV_STATUSES = ['MOVING_TO_ISLAND_1', 'LOADING', 'MOVING_TO_ISLAND_2', 'UNLOADING'];
        
        let stations = JSON.parse(JSON.stringify(INITIAL_STATIONS));
        let agv = { status: 'MOVING_TO_ISLAND_2', battery: 85 };
        let systemEfficiency = 72;
        let activeAlerts = 0;

        // --- RENDER HELPERS ---
        function getStatusColor(status) {
            switch(status) {
                case 'RUNNING': return 'bg-emerald-500/20 text-emerald-400 border-emerald-500/50';
                case 'IDLE': return 'bg-blue-500/20 text-blue-400 border-blue-500/50';
                case 'BLOCKED': return 'bg-amber-500/20 text-amber-400 border-amber-500/50';
                case 'ERROR': return 'bg-red-500/20 text-red-400 border-red-500/50';
                case 'MAINTENANCE': return 'bg-purple-500/20 text-purple-400 border-purple-500/50';
                default: return 'bg-gray-500/20 text-gray-400 border-gray-500/50';
            }
        }

        function getIconName(status) {
            switch(status) {
                case 'RUNNING': return 'activity';
                case 'IDLE': return 'clock';
                case 'BLOCKED': return 'box';
                case 'ERROR': return 'alert-triangle';
                default: return 'refresh-cw';
            }
        }

        function renderStation(s) {
            const colorClass = getStatusColor(s.status);
            const iconName = getIconName(s.status);
            const isBottleneck = s.waitTime > 10;
            
            // Logic for visual bottleneck alert
            const bottleneckIcon = isBottleneck 
                ? `<i data-lucide="alert-triangle" class="w-3 h-3 text-red-500 animate-bounce inline ml-1"></i>` 
                : '';
            
            const waitTimeColor = isBottleneck ? 'text-red-400' : '';

            // Animation bar (only if running)
            const animationBar = s.status === 'RUNNING' 
                ? `<div class="absolute bottom-0 left-0 h-0.5 bg-current opacity-30 animate-growWidth" style="width: 100%; animation-duration: ${s.cycleTime}s"></div>` 
                : '';

            return `
            <div class="relative p-4 rounded-lg border station-card flex items-center justify-between group ${colorClass}" onclick="toggleBlockage('${s.id}')" title="Click to Simulate Fault">
                
                <div class="flex items-center gap-4">
                    <div class="p-2 rounded-md bg-slate-900/50">
                        <i data-lucide="${iconName}" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm tracking-wide">${s.name}</h3>
                        <div class="text-xs opacity-80 font-mono mt-0.5">${s.status}</div>
                    </div>
                </div>

                <div class="text-right min-w-[80px]">
                    <div class="text-xs uppercase tracking-wider opacity-60 mb-0.5">Wait Time</div>
                    <div class="text-lg font-mono font-bold flex items-center justify-end gap-1 ${waitTimeColor}">
                        ${s.waitTime}s
                        ${bottleneckIcon}
                    </div>
                </div>

                ${animationBar}
            </div>
            `;
        }

        function render() {
            // Render Islands
            const island1HTML = stations.filter(s => s.island === 1).map(renderStation).join('');
            const island2HTML = stations.filter(s => s.island === 2).map(renderStation).join('');
            
            document.getElementById('island-1-container').innerHTML = island1HTML;
            document.getElementById('island-2-container').innerHTML = island2HTML;

            // Render AGV
            document.getElementById('agv-status').innerText = agv.status.replace(/_/g, ' ');
            document.getElementById('agv-battery').style.width = `${agv.battery}%`;
            
            const agvIcon = document.getElementById('agv-icon');
            if (agv.status.includes('MOVING')) {
                agvIcon.classList.add('animate-spin-slow');
            } else {
                agvIcon.classList.remove('animate-spin-slow');
            }

            // Render Metrics
            const oeeEl = document.getElementById('oee-display');
            oeeEl.innerText = `${systemEfficiency}%`;
            oeeEl.className = `text-2xl font-bold ${systemEfficiency > 70 ? 'text-emerald-400' : 'text-amber-400'}`;

            const alertBox = document.getElementById('alert-box');
            const alertCountEl = document.getElementById('alert-count');
            
            activeAlerts = stations.filter(s => s.status === 'BLOCKED' || s.status === 'ERROR').length;
            alertCountEl.innerText = activeAlerts;
            alertCountEl.className = `text-2xl font-bold ${activeAlerts > 0 ? 'text-red-400' : 'text-slate-200'}`;
            
            if (activeAlerts > 0) {
                alertBox.classList.add('bg-red-900/20', 'border-red-500/50', 'animate-pulse');
                alertBox.classList.remove('bg-slate-800', 'border-slate-700');
            } else {
                alertBox.classList.remove('bg-red-900/20', 'border-red-500/50', 'animate-pulse');
                alertBox.classList.add('bg-slate-800', 'border-slate-700');
            }

            // Refresh Icons
            lucide.createIcons();
        }

        // --- SIMULATION LOOP ---
        function runSimulationStep() {
            // 1. Update Stations
            stations = stations.map(s => {
                let newStatus = s.status;
                let newWait = s.waitTime;

                // HEATER BOTTLENECK SIMULATION LOGIC
                if (s.id === 'heating') {
                    // Heater usually running (slow)
                    newStatus = Math.random() > 0.1 ? 'RUNNING' : 'MAINTENANCE';
                } else if (s.id === 'muscle') {
                    // Muscle often blocked waiting for heater
                    newStatus = Math.random() > 0.4 ? 'BLOCKED' : 'RUNNING';
                    if (newStatus === 'BLOCKED') newWait += 0.5;
                } else if (s.id === 'output') {
                    // Output often idle
                    newStatus = Math.random() > 0.6 ? 'IDLE' : 'RUNNING';
                } else {
                    // Random fluctuations for others
                    const roll = Math.random();
                    if (newStatus !== 'BLOCKED') { // Don't override manual blocks immediately
                        if (roll > 0.9) newStatus = 'IDLE';
                        else if (roll > 0.98) newStatus = 'ERROR';
                        else newStatus = 'RUNNING';
                    }
                }

                if (newStatus === 'RUNNING') newWait = Math.max(0, newWait - 0.2);
                else newWait += 0.1;

                return { ...s, status: newStatus, waitTime: parseFloat(newWait.toFixed(1)) };
            });

            // 2. Update AGV
            if (Math.random() > 0.7) {
                let currentIndex = AGV_STATUSES.indexOf(agv.status);
                let nextIndex = (currentIndex + 1) % AGV_STATUSES.length;
                agv.status = AGV_STATUSES[nextIndex];
                agv.battery = Math.max(10, agv.battery - 0.1);
            }

            // 3. Update OEE
            const target = 68 + (Math.random() * 10);
            systemEfficiency = parseFloat((systemEfficiency * 0.9 + target * 0.1).toFixed(1));

            render();
        }

        // --- INTERACTION ---
        window.toggleBlockage = function(id) {
            stations = stations.map(s => {
                if (s.id === id) {
                    return { ...s, status: s.status === 'BLOCKED' ? 'RUNNING' : 'BLOCKED', waitTime: s.status === 'BLOCKED' ? 0 : 25 };
                }
                return s;
            });
            render();
        };

        // --- INIT ---
        window.onload = function() {
            render();
            setInterval(runSimulationStep, 2000);
        };
    </script>
</body>
</html>